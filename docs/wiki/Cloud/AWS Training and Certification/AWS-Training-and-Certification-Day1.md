---
slug: "AWS-Training-and-Certification-Day1"
---

# DevOps 소개

## DevOps란?
![Pasted-image-20230322171034.png](/img/Pasted-image-20230322171034.png)
:::info DevOps란?
DevOps는 소프트웨어 개발과 정보 기술 운영을 결합한 <mark>문화 철학</mark>, <mark>사례</mark> 및 <mark>도구의 결합</mark>입니다.
이러한 사례를 통해 기업은 새 애플리케이션 기능과 개선된 서비스를 더욱 빠른 속도로 고객에게 전달합니다.

:::

## Amazon의 개발
![Pasted-image-20230322171539.png](/img/Pasted-image-20230322171539.png)
- 초기 Amazon도 애플리케이션 개발의 접근방식이 모놀리식이었습니다.
- 즉, <mark>단일 대형 플랫폼</mark>에서 단일 티어로 결합된 서로 다른 구성 요소로 구성되어 <mark>밀결합된</mark> 아키텍쳐였습니다.
- 애플리케이션의 업데이트가 필요한 경우 라이브 플랫폼만 사용 가능하므로, 모든 업데이트가 위험했습니다.
- 모놀리식 아키텍처는 관리에 많은 시간이 소요되었고, 유연성이 부족했습니다.
- 또한 내결함성이 낮았습니다.

- 그리고 추가적으로 개발자와 기타 관련 팀은 서로 분리되어 있으며, 서로 커뮤니케이션 하지 않았습니다.
- 피드백이 좋지 않거나 없었습니다.
- 프레임워크는 확장성이나 운영 민첩성을 달성할 수 없었으며, 반복된 배포로 인해 개발자 속도가 느려저서 제공 수명 주기가 길어졌습니다.
- 여러 팀이 동시에 개발하면서 서로 커뮤티케이션하지 않았기 때문에, 코드 변경이 사전적이 아닌 반응적인 경우가 많았습니다.

## 모놀리식의 문제점
:::danger 모놀리식 문제점 요약
- 단일 대형 플랫폼
- 긴 개발 주기
- 확장의 복잡성
- 장애가 전체 아키텍처에 영향을 미침
- 장애 도는 버그 수정을 위한 리팩토링

:::

## Aamzon의 MSA
- 서비스의 수가 증가하고, 더욱 복잡한 아키텍쳐가 개발됨에 따라 Amazon은 더 큰 효율성을 추구하고 DevOps를 적용해야만 했습니다.
- 조직은 부서 계층 구조를 MSA로 작업하는 더욱 작고 민첩성이 뛰어난 자율 팀으로 분해하여 조직을 전환했습니다.
![Pasted-image-20230322174146.png](/img/Pasted-image-20230322174146.png)
- Amazon은 이 MSA 팀을 Two Pizza팀으로 나누었습니다.
	- 두판의 피자를 먹을 수 있는 아주 작은 소규모의 팀(4~5명)
- MSA는 어플리케이션만 분리하는 것이 아닌 <mark>조직도 분리</mark>를 해야합니다.

:::success Two Pizza Team 접근 방식으로 얻은 이점
- 고객 요구 사항을 충족하는 역량 증가
- 개발 주기의 소유권 확보
- 혁신에 대한 자유도 증가
- 민첩성 개선

:::

## 소규모 팀 속성
![Pasted-image-20230322174545.png](/img/Pasted-image-20230322174545.png)


:::success 이점
피자 두판 팀은 제품에 대한 <mark>소유권</mark>을 갖습니다. 
- 소유권을 통해 <mark>책임</mark>이 증가합니다.
- 소규모 팀은 개발부터 운영까지 전체 프로젝트 주기를 완벽하게 제어하고 소유하기 때문에 <mark>DevOps 원칙</mark>을 사용합니다.
- 팀의 규모가 작아지면 조직 전체가 하나의 아이디어를 실행하도록 구성할 필요 없이, 각자 <mark>제품에 관련된 혁신</mark>에만 집중하 수 있습니다.


:::

## DevOps 혁신을 주도하는 요인
![Screenshot-2023-03-22-at-5.50.43-PM.png](/img/Screenshot-2023-03-22-at-5.50.43-PM.png)
:::tip 도구도 중요하지만, DevOps는 문화 철학이라는 사실을 잊으면 안됩니다.
:::

- 위의 사진처럼 3개의 요소가 있습니다.
- 각각의 주요 원칙이 DevOps의 강화에 도움이 됩니다.
- 조직이 이러한 원칙을 이해하면, 더 나은 엔지니어링 지원(사례와 패턴을 통한)과 적절한 도구를 통한 빌더 지원에 도움이 됩니다.

- 과거에는 개발자가 여러 인프라에 빠르고 효과적으로 배포할 수 있는 방법을 찾아야 했고, 이를 통해 자동화가 이루어졌습니다.
- 처음에는 배포만 자동화 되었습니다.
- 이후 MSA의 복잡성 관리를 위해 제품의 전체 개발 주기가 처음부터 끝까지 자동화 되었습니다.
- 이를 지속적 통합/지속적 전달(CI/CD) 파이프라인이라 합니다.

- 자동화는 이점을 실현할 뿐만 아니라, 개발자는 더욱 빠르게 릴리스하고 더 높은 품질의 제품을 빌드할 수 있었습니다.
- 도구와 자동화를 결합함으로써 기업은 혁신을 향해 모멘텀을 구축하고 속도를 높일 수 있습니다.


# DevOps 문화
:::note Devops는 장벽을 제거하는 것입니다.
DevOps에서는 팀이 함께 작업하여 개발자의 생산성과 운영의 안정성 모두를 최적화 합니다.
:::

- DevOps로 전환하기 위해서는 문화와 사고 방식의 변화가 필요합니다.
- 간단하게 말하자면, DevOps는 기존 사일로에 묶여 있던 두 팀간의 장벽을 없앱니다.
- DevOps를 통해 소프트웨어 릴리스의 제공을 원할하게 하는 동구와 사례를 제공하며, 장벽을 제거할 수 있습니다.
- 일부 기업에서는 별도의 팀이 없을 수도 없으며, 엔지니어가 두가지 작업을 모두 수행할 수 도 있습니다.
- 또한 DevOps가 피드백 루프를 단축하는 데 도움이 되고 지속적인 실험을 촉진한다는 사실을 깨닫는 것도 중요합니다.

- DevOps를 통해 두 부서는 함께 작업하여 개발자의 생산성과 운영의 안정성을 최적화 합니다.
- 두 팀은 자주 커뮤티케이션하고, 효율성을 높이고, 품질을 향상 시킵니다.
- 이들은 제공하는 서비스의 완전한 소유권을 가지며, 이는 주로 전통적인 역할의 범위를 넘어서는데, 
- 이는 고객의 요구사항과 이러한 요구사항을 해결하는 데 어떻게 기여할 수 있는지 생각하여, 달성할 수 있습니다.
- 품질 보증 및 보안 팀도 이 두팀과 긴밀하게 통합 될 수 있습니다.

- 조직 구조와 무관하게 DevOps 모델을 사용하는 기업은 전체 개발 및 인프라 수명 주기를 자신의 책임으로 간주하는 팀들로 구성됩니다.
- 도구보다 <mark>프로세스</mark>, 프로세스보다 <mark>사람</mark> 입니다.
- 관계가 고려해야 할 가장 중요한 요소이며, 프로세스와 도구는 그 뒤를 따른다는 것을 의미합니다.

:::note DevOps의 목표는 반복 가능하며, 신뢰할 수 있으며, 복원력이 뛰어나고, 안정적이고, 안전하며, 운영 효율성을 향상하는 지속적인 전달 모델을 따르는 것이다.
:::

- 하지만, 작업 팀이 여전히 사일로 형태로 작업하는 경우 DevOps 접근 방식은 어떻게 도움이 될까요?
- 팀 간의 관계가 중요합니다.
- 팀 간 커뮤니케이션 및 협업이 없으면 프로세스가 실패할 수도 있습니다.
- 팀은 서로 협업하고 개발 및 전달 프로세스에 참여해야합니다.

:::quote 작업 팀이 여전히 사일로 형태로 작업하는 형태로 작업하는 경우 DevOps 접근 방식은 어떻게 도움이 될까?
- 팀 간의 관계도 중요합니다. 팀 간 커뮤니케이션 및 협업이 없으면, 프로세스가 실패할 수도 있습니다.
- 팀은 서로 협업하고 개발 및 전달 프로세스에 참여해야합니다.
- 모든 기술 팀원이 개발 파이프라인과 관련된 프로세스 및 도구에 대한 경험이 있어야 합니다.

:::

### 속도
- 작업 속도가 빨라지므로 고객을 위해 더 빠르게 혁신하고, 시장 변화에 더 잘 적응하고, 좀 더 효율적으로 비즈니스 성과를 창출 할 수 있습니다.
- DevOps 모델을 사용하면 DevOps 팀이 이러한 성과를 달성 할 수 있습니다.

### 신속한 제공
- 릴리스의 빈도와 속도를 개선하여 제품을 더 빠르게 혁신하고 개선할 수 있습니다.
- 새로운 기능의 릴리스와 버그 수정 속도가 빨라질 수록 고객의 요구에 더 빠르게 대응하여, 경쟁 우위를 강화할 수 있습니다.
- 지속적 통합과 전달은 빌드에서 배포까지 소프트웨어 릴리스 프로세스를 자동화 하는 방식 입니다.

### 안정성
- 최종 사용자에게 지속적으로 긍정적인 경험을 제공하는 한편 더욱 빠르게 안정적으로 제공할 수 있도록 애플리케이션 업데이트와 인프라 변경의 품질을 보장합니다.
- 지속적 통합 및 지속적 전달과 같은 방식을 사용하여, 각 변경 사항이 제대로 작동하며 안전한지 테스트 합니다.

### 확장
- 규모에 따라 인프라와 개발 프로세스를 운영 및 관리합니다.
- 자동화와 일관성이 지원되므로 위험을 줄이면서, 복잡한 시스템 또는 변화하는 시스템을 효율적으로 관리 할 수 있습니다.

### 협업 강화
- 소유권 및 책임과 같은 가치를 강조하는 DevOps 문화 모델에서 좀 더 효과적인 팀을 구축합니다.
- 개발자와 운영 팀은 긴밀하게 협력하고, 많은 책임을 공유하며, 워크플로를 결합합니다.
- 이를 통해 비효율성을 줄이고 시간을 절약할 수 있습니다.

### 보안
- 제어를 유지하고, 규정을 준수하면서 신속하게 진행할 수 있습니다.
- 자동화된 규정 준수 정책, 세분화된 제어 및 구성 관리 기술을 사용하믕로써 보아을 그대로 유지하면서 DevOps 모델을 도입할 수 있습니다.
- 좋지 않는 보안 사례는 민첩성을 저해하고, 취약점을 만들고, 잘못된 구성과 안전하지 않는 코드 및 아키텍처의 약점을 만들 수 있습니다.

## 지속적 전달
![Pasted-image-20230322225938.png](/img/Pasted-image-20230322225938.png)
- CI/CD 는 개발을 위한 소프트웨어 제공 프로세스를 지원하는 데 도움이 되는 파이프라인의 프로세스 입니다.
- 앞서 커뮤니케이션 및 협업에 대해 언급한 것처럼 잦은 커뮤니케이션의 원칙과 고객이 변화에 대한 피드백을 제공할 수 있는 기회를 통해 DevOps가 CI/CD가 연결된다는 것을 깨닫는 것이 중요합니다.

### 지속적 통합(CI)
- 개발자가 지속적으로 소스를 통합하고, 빌드 및 테스트 단계를 자동화 할 수 있는 프로세스 입니다.

### 지속적 전달(CD)
- 지속적 통합 단계이지만, 프로비저닝, 배포, 그리고 마지막으로 사후 테스트 또는 모니터링이 포함 됩니다.

:::note 다음 CD 모범 사례가 적용되면, 언제든 소프트웨어를 프로덕션에 릴리스 할 수 있다.
- 코드 변경 사항이 자주 리포지토리로 커밋되고, 빌드 된다.
- 빌드는 테스트 환경에 배포되고 자동화된 테스트 및 가능한 경우 수동 테스트를 사용하여 테스트 됩니다.
- 염격한 테스트를 통과한 빌드가 스테이징 또는 프로덕션 환경에 신속하게 배포 된다

:::

:::note 강력한 지속적 전달 파이프라인에서는 다음을 수행한다.
- 테스트 및 프로덕션 환경을 위한 인프라 프로비저닝을 자동화 한다.
- 테스트 및 프로덕션 환경을 모니터링하고 관리할 수 있습니다.
:::

- 지속적 배포는 완전 자동화된 엔드 투 엔드 프로세스 입니다.

## MSA 이전 모놀리식
![Screenshot-2023-03-22-at-11.07.06-PM.png](/img/Screenshot-2023-03-22-at-11.07.06-PM.png)
- 이전 모놀리식 모델에서는 다음과 같은 형태일 수 있습니다.
- Amazon의 경우 큰 규모의 개발자 팀이 대규모 모놀리식 앱을 허물어 QA, 릴리스 및 운영 팀에 나누었고, 이들은 프로덕션까지 이를 천천히, 그리고 드물게 이끌었습니다.
- 

## MSA
![Screenshot-2023-03-22-at-11.08.30-PM.png](/img/Screenshot-2023-03-22-at-11.08.30-PM.png)
- 샘플 MSA는 위에 표시 됩니다.
- 솔루션은 셀프 서비스 도구와 자동화로, 이를 통해 DevOps 팀은 자체 릴리스 프로세스를 소유 및 관리 할 수 있습니다.

- 기업은 MSA를 이용하여, 애플리케이션의 유연성과 혁신의 속도를 높일 수 있습니다.
- MSA는 소프트웨어가 잘 정의된 API를 통해 통신하는 소규모의 독립겆ㄱ인 서비스로 구성되어 있는 경우의 소프트웨어 개발을 위한 아키텍쳐 및 조직적인 접근 방식입니다.
- 이러한 서비스는 독립적인 소규모 팀에서 보유합니다.
- MSA는 애플리케이션의 확장을 용이하게 하고, 개발 속도를 앞당겨 혁신을 실현하고, 새로운 기능의 출시 시간을 단축할 수 있도록 합니다.

- MSA는 애플리케이션이 각 애플리케이션 프로세스를 서비스로 실행하는 독립적인 구성 요소로 구축된다. 이러한 서비스는 경량 API를 사용하여 잘 정의된 인터페이스를 통해 통신합니다.
- 서비스는 비즈니스 기능을 위해 구축되며 서비스마다 한 가지 기능을 수행합니다.
- 서비스가 독립적으로 실행되므로 각 서비스를 업데이트, 배포 및 조정하며 애플리케이션의 특정 기능의 수요를 충족 할 수 있습니다.

## Infrastructure as Code
![Screenshot-2023-03-25-at-12.00.29-PM.png](/img/Screenshot-2023-03-25-at-12.00.29-PM.png)
- 코드형 인프라는 버전 제어나 지속적 통합과 같은 코드 및 소픝웨어 개발 기법을 사용하여 인프라를 프로비저닝하고 관리하는 방식이다.
- 클라우드 API 기반 모델을 사용하면 개발자와 시스템 관리자가 수동으로 리소스를 설정 및 구성할 필요 없이 규모에 따라 프로그래밍 방식으로 인프라와 상호 작용할 수 있다.
- 따라서 엔지니어는 코드 기반 도구를 사용하여 인프라와 인터페이스하고 애플리케이션 코드를 다루는 방법과 유사한 방식으로 인프라를 다룰 수 있다.
- 인프라가 코드를 통해 정의되므로 인프라와 서버를 표준화된 패턴을 사용하여 배포하고, 최신의 패치와 버전으로 업데이트하거나, 반복 가능한 방식으로 복제 할 수 있다.

## 모니터링 및 로깅
![Pasted-image-20230325120532.png](/img/Pasted-image-20230325120532.png)
- 애플리케이션 및 인프라에서 대규모 데이터 세트를 관찰하고 추적
- 운영 가시성 및 통찰력
- 지표 수집
- 성능 개선

- 조직은 지표와 로그를 모니터링하여 애플리케이션 및 인프라 성능이 제품의 최종 사용자 경험에 어떤 영향을 미치는지 확인 한다.
- 조직은 애플리케이션과 인프라에서 생성되는 데이터 및 로그를 캡쳐하고 분류한 다음 이를 분석함으로써 변경 또는 업데이트가 사용자에게 어떤 영향을 주는지 이해하고, 문제의 근본 원인 또는 예상치 못한 변경에 대한 통찰력을 확보합니다.
- 서비스가 연중 무효 24시간 동안 가동되어야 하고, 애플리케이션과 인프라 업데이트 빈도가 증가함에 따라 능동적 모니터링이 점점 더 중요해지고 있다.
- 경고를 생성하거나 이러한 데이터를 실시간으로 분석하는 것도 기어빙 좀 더 능동적으로 서비스를 모니터링하는 데 도움이 된다.
- 이후 과정에서 구체적인 관측 가능성, 보안, 로그 및 모범 사례를 논의 하겠다.

## 커뮤니케이션 및 협업
![Pasted-image-20230325121013.png](/img/Pasted-image-20230325121013.png)
- 조직에서 커뮤니케이션과 협업이 증가하는 것도 DevOps의 주요 문화적 측면 중 하나이다.
- DevOps 도구와 소프트웨어 전달 프로세스 자동화를 사용하면 개발 및 운영의 워크플로와 책임을 물리적으로 합침으로서 협업이 이루어진다.
- 이름 바탕으로 이러한 팀에서는 이 위에 채팅 애플리케이션, 문제 도는 프로젝트 추척 시스템, Wiki를 사용하여 커뮤니케이션을 지원하고 정보를 공유하는 강력한 문화적 규범을 확립합니다.
- 이를 통해 개발자와 운영 그리고 마케팅이나 영업과 같은 다른 팀간에도 커뮤티케이션이 활발해지면서 기업의 모든 부분에서 모교와 프로젝츠에 더욱 가깝게 다가갈 수 있습니다.
- 커뮤니케이션과 협업을 수립하여 피드백과 중요한 메시지가 효율적으로 전달되도록 하는 것이 중요하다.
- 이러한 피드백을 통해 아키텍처와 제품을 더욱 빠르게 해겨랗고 업데이트 합니다.

## 최신 애플리케이션 및 아키텍처
- **서버리스 기술**로 환경 관리 간소화
- **마이크로서비스 아키텍처**로 코드 변경
- 애플리케이션 및 **코드형 인프라 모델링**으로 운영 자동화
- CI/CD로 새로운 고품질 서비스 제공 가속화
- 관측 가능성 지원으로 리소스와 앱에 대한 인사이트 획득
- 엔드 투 엔드 보안 및 규정 준수로 고객/비즈니스 보호

## AWS 기반 DevOps
![Screenshot-2023-03-25-at-12.35.13-PM.png](/img/Screenshot-2023-03-25-at-12.35.13-PM.png)
- AWS에서는 DevOps를 적용하는데 도움이 되며, AWS와 연동하여 사용하도록 구축된 서비스를 제공합니다.
- 이러한 도구를 사용하면 수동 작업을 자동화하고, 팀에서 대규모의 복잡한 환경을 관리 할 수 있으며, 엔지니어는 DevOps를 통해 빠른 속도를 유지 관리 할 수 있습니다.

# 인프라 자동화
## 자동화가 필요한 이유?
:::tip 인프라 자동화란?
구성 파일과 같이 코드를 통해 인프라를 정의한다.

:::

### 코드형 인프라의 구성 요소
- 셸 스크립트
- 애플리케이션 코드
- AWS CloudFormation
- Terraform


- DevOps의 다리 셋 달린 의자는 DevOps 철학의 핵심인 세 가지 구성 요소를 의미한다.
- 하나는 자동화이다.
- 자동화는 설정, 구성, 배포, 인프라 지원, 동일한 인프라에서 실행되는 애플리케이션 등 DevOps의 여러 구성 요소에 초점을 맞춥니다.
- 이러한 의미에서 자동화는 릴리스 프로세스의 자동 프로레스를 말합니다.

- 가장 성공적인 DevOps 전략의 핵심은 자동화입니다.
- 수동 프레스에서는 안정성이 떨어지고 민첩한 아키텍처에 대한 지원이 부족하기 때문에 오류가 자주 발생합니다.
- 하지만 정의에 따라 자동화는 모든 **소프트웨어 릴리스**, **머신 구성**, **운영 체제 패치**, **문제 해결** 및 **버그 수정**을 포함한 구동 개입 및 프로덕션 환경에 대한 액세스를 제거합니다.
- 다양한 수준의 자동화 사례를 결합하면 고급 자동화 프로세스를 제공할 수 있다.
- 자동화를 사용하고, 환경에 효과적으로 적용하는 것은 모든 이점을 실혐 하는데 있어 매우 중요하다.

#### 자동화가 중요한 이유
- 개발자/관리자는 주로 인프라를 수동으로 프로비저닝 해야한다.
- 관리자와 개발자 모두 수동 단계에 의존하는 대신 구성 파일을 사용하여 인프라를 인스턴스화 할 수 있다.
- 코드형 인프라(IaC)는 이러한 구성 파일을 소프트웨어 코드로 취급합니다.
- 이러한 파일을 사용하여 운영 환경을 구성하는 컴퓨팅, 스토리지, 네트워크 및 애플리케이션 서비와 같은 아티팩트 세트를 생성 할 수 있다.
- 코드형 인프라는 자동화를 통한 구성 드리프트를 제거하여 인프라 배포의 속도와 민첩성 높입니다.

## 자동 인프라 프로비저닝
- 인적 실수 감수(구성 표준과의 편차 방지)
- 더욱 빠른 릴리스 및 응답 시간
- 코드형 정책으로 규정 준수 유지
	- 추적, 검증 및 재 구성 가능(모두 자동화를 통해 이루어짐)

:::info 인프라 자동화의 이점
- 수동 프로레스를 제거하고 인프라 프로비저닝을 자동화하면 인정 오류로 인해 발생할 수 있는 불일치를 줄 일 수 있다.
- 또한 자동화는 구성 표준과의 편차를 줄일 수 있습니다.
- 민첩한 인프라를 구축하는 것은 혁신 유지를 위한 핵심이며, 빠른 속도로 개발 및 릴리스 할 수 있다.
- 인프라 프로비저닝을 자동화하면 개발 팀은 반복 가능한 프로세스이므로 규정 준수 표준을 유지 할 수있다.

:::

## 코드형 인프라의 이점
- 애플리케이션 코드 처럼 버전 지정 및 관리가 가능하다.
- 반복적으로 그리고 안정적으로 생성, 종료 및 재 생성이 가능하다.
- 애플리케이션의 최신 버전 테스트 필요성에 따라 생성이 가능하다.

#### 코드형 인프라를 통해 다음이 가능하다.
- 여러 환경의 생성
- 여러 고객에 대한 동일한 환경 생성

## AWS CloudFormation과 DevOps
- AWS 관리 콘솔, AWS CLI, AWS SDK 또는 AWS CodePipeline을 사용하여, 템플릿에서 스택의 자동 인스턴스화
- 오류 제거를 위한 파라미터 검증
- 복잡한 시스템 구축을 위한 스택 연결 및 중첩
- 시스템을 함께 연결하고, 연결하고 배포를 검증하는 데 사용할 수 있는 사용자 지정 리소스
- 인프라 변경을 간소화하고 중요 리소스를 보호하는 데 도움이 되는 추가 기능

- AWS CloudFormation은 AWS 리소스를 모델링하고 설정하여 리소스 관리 시간을 줄이고 AWS에서 실행되는 애플리케이션에 더 많은 시간을 사용하도록 해주는 서비스이다.
- Amazon Elastic Compute Cloud(EC2) 인스턴스 또는 Amazon Relational Database Service(Amazon RDS) DB 인스턴스 등 원하는 모든 AWS 리소스를 설명하는 템플릿을 생성할 수 있으며, AWS 리소스를 개별적으로 생성 및 구성하고 상호 의존성을 파악할 필요가 없다.
- AWS CloudFormation에서 이 모든 것을 처리한다.
- 타사 도구에는 HashiCorp의 Terraform이 있다.
- Terraform은 AWS 및 다른 클라우드 공급자 모두와 작동한다.
- Chef 및 Puppet과 같은 다른 도구는 컴퓨팅 및 스토리지 리소스를 프로비저닝 할 수 있기 때문에 코드형 인프라로 간주 도리 수 있다.
- 또 다른 인기 도구는 프로비저닝, 구성 관리, 배포 및 오케스트레이션을 지원하는 IT 자동화 플랫폼인 Ansible입니다.

## AWS CloudFormation 템플릿 구조 : YAML 형식
```yaml
---
AWSTemplateFormatVersion : "2010-09-09"

Description:
	String
Parameters: 
	set of parameters
Mappings:
	set of mappings
Conditions:
	set of conditions
Transform:
	set of transforms
Resources:
	set of resources
Outputs:
	set of outputs
```
|Section|Description|
|--|--|
|Format Version(Optional) | 해당하는 AWS CloudFormation 템플릿 버전|
| Description(Optional) | 텍스트 문자열|
| Parameters(Optional) | 템플릿 입력 | 
| Mappings(Optional) | 정적 변수, Key-Value Pair |
| Conditions(Optional) | 특정 리소스의 생성 또는 업데이트 여부와 시기를 제어 |
| Transform(Optional) | 사용할 AWS SAM 버전을 지정 |
| Resources(Require) | 생성할 AWS 자산 |
| Outputs(Optional) | 템플릿에서 생성하는 사용자 지정 리소스 값(URL, 사용자 이름 등) | 

- AWS CloudFormation 템플릿에는 몇 가지 주요 섹션이 포함 되어 있지만, 필요한 섹션은 Resource 섹션 뿐입니다.
- 템플릿의 일부 섹션은 순서에 구애를 받지 않습니다.
- 하지만 한 섹션의 값이 이전 섹션의 값을 참조할 수 있으므로, 템플릿을 구축할 때 논리적 순서를 따르는 것이 유용할 수 있습니다.

템플릿의 각 섹션에 대한 간략한 개요는 
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-anatomy.html
를 참조하면 됩니다.


## 파라미터
```yaml
Parameters:
	InstanceTypeParameter:
		Type: String
		Default : t2.small
		AllowedValues:
			- t2.small
			- al.xlarge
			- t3a.xlarge
			- c5n.xlarge
		Description: Enter t2.small, a1.xlarge, t2a.xlarge or c5n.xlarge. Default is t2.small
```
- 선택 사항인 Parameters 섹션을 사용하여 템플릿을 사용자 지정합니다.
- 파라미터를 통해 스택을 생성하거나 업데이트 할 때 마다 템플릿에 사용자 지정 값을 입력할 수 있습니다.
- 스택이란 하나의 단위로 관리 할 수 있는 AWS 리소스 모음입니다.

- 또한 스택을 생성하거나 업데이트 할 때 잘못된 값을 포착하는 데 유용한 특정 AWS 파라미터 유형돟 있습니다.
- 특정 AWS 유형을 사용하여 파라미터를 지정하려면 템플릿 사용자가 자신의 AWS 계정에 있는 기존 AWS 값을 입력해야한다.
- AWS CloudFormation은 계정의 기존 값에 대해 이러한 입력 값을 검증한다.
- 예를 들어 AWS::EC2::VPC::Id 파라미터 유형을 사용하는 경우 사용자는 스택을 생성 중인 AWS 리전과 계정에 있는 기존 Virtual Private Cloud(VPC)ID를 입력해야 한다.

## 파라미터 검증
- AllowedPattern : 입력 값을 제한하는 정규 표현식 지정
	- AllowedPattern : `(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3}\\.(\\d{1,3})/(\\d(1,3})`
- AllowedValues: EC2 인스턴스 유형과 같은 옵션 세트를 지정
	- AllowedValues: `['t2.micro', 't2.small', 'i3.2xlarge']('t2.micro', 't2.small', 'i3.2xlarge')`
- 파라미터 Type: 기존 요소를 검증하는 입력 유형(문자열, 정수) 및 AWS별 유형을 지정
	- AWS::EC2::KeyPair::KeyName
- Default에서 기본 값을 지정한다.

- 올바른 파라미터 유형과 제약 조건을 활용하면 AWS CloudFormation 스택을 자동으로 프로비저닝할 때 오류를 방지하는 데 도움이 될 수 있다.
- 올바르게 사용하는 경우 파라미터 검증으로 입력이 잘못 되었을 때 낭비되는 리소스(및 비용)가 생성되지 않도록 한다.
- 파라미터 유형 `EC2::KeyPair::KeyName`이 사용되고 잘못된 키 페어(다른 리전의 키 페어 이름일 수 있음)가 입력된 경우 리소스 생성 전에 스택 생성에 실패한다.
https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html

## CreationPolicy 속성
![Screenshot-2023-03-25-at-4.52.20-PM.png](/img/Screenshot-2023-03-25-at-4.52.20-PM.png)
- CreationPolicy 속성은 스택 생성을 진행하기 전에 리소스 구성 작업을 기다리려는 경우에 유용합니다. 예를 들어 Amazon EC2 인스턴스에 소프트웨어 애플리케이션을 설치 및 구성한 경우, AWS CloudFormation이 해당 애플리케이션에 종속된 추가 리소스를 생성하기 전에 해당 애플리케이션을 실행해야 할 수 있습니다.
- 이러한 경우, CreationPolicy 속성을 인스턴스에 추가할 수 있다.
- 그러면 이 속성이 애플리케이션이 설치 및 구성된 후 인스턴스에 성공 신호를 보내도록 AWS CloudFormation에 지시합니다.

- CreationPolicy 속성을 리소스에 연결하여 AWS CloudFormation이 지정된 수의 성공 신호를 수신하거나 제한 시간이 초과할 때까지 리소스가 **create complete** 상태에 도달하지 않도록 할 수 있다.
- 리소스에 신호를 보내려면 cfn-signal 헬퍼 스크립트 또는 SignalResource API를 사용하면 된다.
- AWS CloudFormation이 유효한 신호를 스택 이벤트에 게시하므로 전송된 신호 수를 추적할 수 있습니다.
- 생성 정책은 AWS CloudFormation이 연결된 리소스를 생성할 때만 호출 됩니다.
	- 현재 생성 정책을 지원하는 AWS CloudFormation 리소스는 `AWS::AutoScaling::AutoScalingGroup`, `AWS::EC2::Instance` 및 `AWS::CloudFormation::WaitCondition` 뿐 입니다.
- 이 예시에서는 생성 정책이 어떻게 EC2 Auto Scaling 그룹에 적용되는지 보여줍니다.
- EC2 Auto Scaling 그룹에 기본적으로 2개의 인스턴스를 유지하도록 지정하는 경우, Auto Scaling 그룹이 양쪽 인스턴스에서 신호를 수신해야 `CREATE_COMPLETE`로 표시되도록 지정할 수 있다.

## Auto CloudFormation 모범 사례
- 모범 사례는 다음을 중심으로 다루어야 합니다.
	- 스택 계획 및 구성
	- 템플릿 생성
	- 스택 관리
- 모범 사례는 전체 워크플로에서 AWS CloudFormation을 더욱 효과적이고 안전하게 사용할 수 있게 도와주는 권장사항 입니다.
- 스택 계획 및 준비, 스택에서 실행되는 리소스 및 소프트웨어 애플리케이션을 설명하는 템플릿 생성, 스택 및 리소스 및 소프트웨어 애플리케이션을 설명하는 템플릿 생성 스택 및 리소스 관리 방법에 대해서 알아볼 수 있습니다.

- AWS CloudFormation 모범 사례
	- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html
- AWS CloudFormation에 대한 보안 모범 사례
	- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html

## AWS CloudFormation 스택
- 콘솔 또는 AWS CLI를 통해 스택 생성
- 공통 파라미터:
	- ClientRequestTocken
	- OnFailure
	- TimeoutInMinutes
- 기존 리소스 가져오기
![Screenshot-2023-03-25-at-5.07.50-PM.png](/img/Screenshot-2023-03-25-at-5.07.50-PM.png)

- 템플릿에 지정된 대로 스택을 생성합니다. 호출이 성공적으로 완료되면 스택 생성이 시작됩니다.
- DescribeStacks API를 통해 스택의 상태를 확인 할 수 있습니다.

- **ClientRequestTocken** CreateStack 요청에 대한 고유 식별자입니다.
- 요청을 재시도하여 사용자가 동일한 이름의 스택을 생성하지 않을 것임을 AWS CloudFormation에 알릴 계획인 경우 이 토큰을 지정합니다.
- CreateStack 요청을 다시 시도하여 AWS CloudFormation에서 요청을 성공적으로 수신했는지 확인 할 수 있습니다.
- **OnFailure** 스택 생성이 실패한 경우 수행할 작업을 결정합니다.
- 다음 중 하나여야 합니다.
	- DO_NOTHING, ROLLBACK or DELETE. OnFailure 또는 DisableRollback을 지정할 수 있지만, 둘 다 지정할 수 없습니다.
- **TimeoutInMinutes** 스택 상태가 CREATE_FAILED가 되기 전에 경과할 수 있는 시간 입니다.
	- DisableRollback이 설정되어 있지 않거나, False로 설정 되어 있으면 스택이 롤백 됩니다.
- 파라미터 추가 예시는
	- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html
- 스택에 이미 포함되어 있는 리소스와 가져올 리소스를 모두 포함한 전체 스택을 설명하는 템플릿
- 가져올 각 리소스의 템플릿에느 `DeletionPolicy`속성이 있어야 합니다.
- 각 대상 리소스에 대한 고유 식별자, 식별자를 얻으려면 해당 서비스 콘솔을 방문해야합니다.

## 스택: 계층화된 아키텍쳐 접근 방식
![Screenshot-2023-03-25-at-5.17.15-PM.png](/img/Screenshot-2023-03-25-at-5.17.15-PM.png)
:::question AWS CloudFormation 템플릿의 생성 및 관리 계획은 어떻게?

:::

## stack : 중첩 스택 접근 방식
![Screenshot-2023-03-25-at-5.18.11-PM.png](/img/Screenshot-2023-03-25-at-5.18.11-PM.png)
- **중첩 스택**은 다른 스택의 일부로 생성된 스택입니다.
- `AWS::CloudFormation::Stack`리소스를 사용하여 다른 스택 내에 중첩 스택을 생성합니다.
- 인프라가 커짐에 따라 여러 템플릿에 동일한 구성 요소를 선언하는 공통 패턴이 나타날 수 있다.
- 이러한 공통 구성 요소를 분리하고 이를 위한 전용 템플릿을 생성할 수 있다.
- 그런 다음 템플릿의 Resource 섹션을 사용하여 다른 템플릿을 참조해 중첩 스택을 생성한다.
- 중첩된 스택을 사용하면 다수의 동일한 템플릿을 결합할 때 세부적으로 제어할 수 있다.
- 모든 항목은 상위 템플릿에서 미리 정의되며 AWS CloudFormation은 상위 템플릿 및 참조된 각 템플릿에 대한 스택을 생성한다.
- 상위 스택에서 업데이트를 수행하면 관련된 모든 스택 전체의 종속성을 간편하게 유지할 수 있다.
- 중첩 스택을 사용하여 공통 구성 요소를 선언하는 것이 일반적인 모범 사례이다.

- 스택 업데이트와 같은 특정 스택 작업을 중첩 스택에서 직접 수행하는 것이 아니라 루트 스택에서 시작하는 것을 고려해야합니다.
- 또한 경우에 따라 중첩 스택은 스택 잡업 수행 방법에 영향을 준다.

- 중첩 스택을 사용하는 경우 Ref함수를 사용하여 인라인 스택의 값을 다른 스택의 파라미터에 대한 기본 값으로 반환 할 수 있다.
- 중첩 스택은 사용 편의성을 개선하지만 스택을 연결하면 제어 기능 및 유연성이 개선 된다.
- 모듈 식으로 배포 시나리오를 다루려면 Quick Start에 따라 하나 이상의 중첩 스택을 배포하는 상위 템플릿을 생성한다.
- 이러한 중첩 스택 중 하나 이상이 Quick Start의 실제 워크로드를 배포하고, 다른 스택은 특정 커밋 수준에서 하위 모듈(각각의 참조된 Quick Start의 Github에 있는 /submodules/quickstart-repo-name 폴더 내부)로 참조 된다.
- 이렇게 하면 참조가 반복 가능하고 예기치 않게 변경되지 않는다.
- 다음 다이어그램은 스택이 어떻게 서로 연결 될 수 있는지에 대한 예시를 보여준다.


## 스택 : 중첩 스택을 사용한 계층화
![Screenshot-2023-03-25-at-5.26.49-PM.png](/img/Screenshot-2023-03-25-at-5.26.49-PM.png)
- 중첩된 스택을 사용하면 다수의 동일한 템플릿을 결합할 때 세부적으로 제어할 수 있다.
- 모든 항목은 상위 템플릿에서 미리 정의되며 AWS CloudFormation은 상위 템플릿 및 참조된 상위 템플릿에서 미리 정의되며 AWS CloudFormation은 상위 템플릿 및 참조된 각 템플릿에 대한 스택을 생성한다.
- 상위 스택에서 업데이트를 수행하면 관련된 모든 스택 전체의 종속성을 간편하게 유지 할 수 있다.
- 중첩된 스택을 사용하는 경우 인라인 스택의 출력 값을 다른 스택의 파라미터에 대한 기본 값으로 참조할 수 있다.
- 중첩 스택은 사용 편의성을 개선하지만 스택을 연결하면 제어 기능 및 유연성이 개선 됩니다.
![Screenshot-2023-03-25-at-5.33.19-PM.png](/img/Screenshot-2023-03-25-at-5.33.19-PM.png)

## MSA
![Screenshot-2023-03-25-at-5.34.13-PM.png](/img/Screenshot-2023-03-25-at-5.34.13-PM.png)
- 일련의 계층 외에 대규모 시스템을 분리하는 또 다른 방법은 서로 연결된 서비스 세트로 나누는 것이다.
- 이 예시에서 제품 웹 사이트에는 인벤토리 관리, 주문, 처리 도는 추천을 위한 별도의 서비스가 있을 수 있다.
- 이러한 각 서비스는 미리 정의된 프로토콜, 즉 HTTP/HTTPS 를 통해 사용할 수 있는 일련의 REST API를 사용하여 다른 서비스와 통신 한다.
- 대규모 시스템은 서로를 호출 할 수 있는 개별 서비스로 분리 된다. 각 서비스는 단일 또는 개별 스택으로 구현 될 수 있다.
- 
- 마이크로 서비스 아키텍처에 대한 자세한 내용은 다음을 참조합니다.
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html

## 스택 업데이트
![Screenshot-2023-03-25-at-5.59.22-PM.png](/img/Screenshot-2023-03-25-at-5.59.22-PM.png)
- AWS CloudFormation은 다음 기법 중 하나를 사용하여 리소스를 업데이트 합니다.
	- **중단 없이 업데이트** : AWS CloudFormation이 해당 리소스 작업을 중단하거나 리소스의 물리적 이름을 변경하지 않고 리소스를 업데이트 합니다.
	- 예를 `AWS::CloudWtch::Alarm` 리소스의 속성을 업데이트하는 경우, AWS CloudFormation은 경보의 구성을 업데이트하며 업데이트 중에도 경보가 중단 없이 계속 작동한다.
	- **일부 중단이 있는 업데이트** : AWS CloudFormation이 일부 중단으로 리소스를 업데이트 하지만, 물리적 이름은 유지 됩니다.
		- 예를 들어 `AWS::EC2::Instance` 리소스의 특정 속성을 업데이트하는 경우, AWS CloudFormation과 Amazon EC2가 인스턴스를 재구성하는 동안 인스턴스가 잠시 중단 될 수 있다.
	- **교체** : AWS CloudFormation이 업데이트 중에 리소스를 다시 생성하며, 이에 따라 새로운 물리적 ID가 생성됩니다.
		- AWS CloudFormation 이 먼저 교체 리소스를 생성하고, 교체 리소스를 가리키도록 다른 종속 리소스의 참조를 변경한 후, 이전 리소스를 삭제한다.
		- 예를 들어 `AWS::RDS::DBInstnace` 리소스의 Engine 속성을 업데이트하는 경우, AWS CloudFormation이 새로운 리소스를 생성하고 현재 DB 인스턴스 리소스를 새로운 리소스로 교체 합니다.
		- 

## 변경 세트
- 변경 세트를 사용하여 다음을 수행합니다.
	- 스택에 대해 제한된 변경 사항 미리 보기
	- 실행 중인 리소스 미치는 영향 확인
	- 변경 사항이 중요한 리소스를 삭제하게나 대체하는지 확인 
- AWS CloudFormation은 사용자가 Change Set를 실행하기로 셜정하는 경우 스택을 변경합니다.

- 변경 세트를 사용하면 수행하려는 변경 사항이 사용자가 실행 중인 스택에 미칠 수 있는 영향을 미리 볼 수 있다.
- 예를 들어 변경 사항이 중요한 리소스를 삭제하거나 대체하는지 여부를 확인 할 수 있다.
- AWS CloudFormation은 사용자가 변경 세트를 실행하기로 결정한 경우에만 스택을 변경하므로, 제안된 변경 사항을 적용할지 아니면 다른 변경 세트를 만들어 다양한 변경 사항을 살펴 볼지 결정 할 수 있다.

- 변경 세트는 AWS CloudFormation에서 스택을 성공적으로 업데이트 할지 여부를 나타내지 않습니다.
- 예를 들어 업데이터를 지원하지 않는 리소스를 업데이트 하는 경우 변경 세트는 계정 제한을 초과하는지 여부를 확인 하지 않습니다.
- 리소스를 수정할 권한이 부족하면, 스택 업데이트에 실패 할 수 있습니다.

- 업데이트가 실패하면 AWS CloudFormation은 리소스를 원래 상태로 롤백하려고 합니다.

## 변경 세트를 사용하여 스택 업데이트
![Pasted-image-20230327082155.png](/img/Pasted-image-20230327082155.png)
- 변경 세트 실행의 기본 워크 플로를 보여주는 다이어그램입니다.
	1. 업데이트하려는 스택의 변경 사항을 제출하여 변경 세트를 생성합니다.
	2. 변경 세트를 보고 어떤 스택 설정과 리소스가 변경될지 식별합니다.
	3. 어떻게 변경할지 결정하기 전에 다른 변경 사항을 고려하면 추가 변경 집합을 만듭니다.
	4. 변경 세트를 실행합니다. AWS CloudFormation이 이러한ㅇ 변경사항을 적용하여 스택을 업데이트 합니다.
자세한 내용은
https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html
를 참고하면 됩니다.

## 변경 세트 생성
```bash
aws cloudformation create-change-set \
	--stack-name NetworkStack \
	--change-set-name SampleChangeSet \
	--use-previous-template \
	--parameters \
		ParameterKey="InstanceType", UsePreviousValue=true
		ParameterKey="KeyPairName", UsePreviousValue=true
		ParameterKey="Purpose", ParameterValue="production"
```
- 표시된 샘플은 SampleStack 스택에 대해 SampleChangeSet라는 변경 세트를 생성합니다.

:::tip 참고
- 템플릿에 DefaultValue 파라미터가 포함되고, UsePreviousValue=true나 특정 값을 지정하지 않는 경우 AWS CloudFormation에서 템플릿 기본값을 사용합니다.

:::

## AWS CloudFormation Helper Script
- 다음 스크립트를 사용하여 스택을 생성할 때 소프트웨어를 설치하고 서비스를 시작합니다.
```bash
cfn-init
cfn-signal
cfn-get-metadata
cfn-hup
```
- AWS CloudFormation은 다음과 같이 Python HelperScript를 제공합니다.
- 이 스크립트를 사용하여 스택의 일부로 생성한 Amazon EC2 인스턴스의 소프트웨어를 설치하고 서비스를 시작할 수 있습니다.
	- `cfn-init`
		- 리소스 메타데이터를 검색 및 해석하고, 패키지를 설치하고, 파일을 생성하고, 서비스를 시작하는데 사용합니다.
		- 일반적으로 사용자 데이터의 일부로 구성됩니다.
	- `cfn-signal`
		- 필수 리소스나 애플리케이션이 준비될 때 스택에서 다른 리소스를 동기화 할 수 있도록 CreationPolicy또는 WaitCondition에서 신호를 전송하는데 사용됩니다.
		- 성공 또는 그 이외의 신호를 제공합니다.
	- `cfn-get-metadata`
		- 특정 키에 대한 리소스나 경로의 메타데이터를 검색하는 데 사용됩니다.
	- `cfn-hup`
		- 메타데이터에 대한 업데이트가 있는지 확인하고 변경 사항이 감지된 경우 사용자 지정 후크를 실행하는데 사용됩니다.
- 템플릿에서 직접 helper script를 호출 할 수도 있다.
- helper script는 동일한 템플릿에서 정의한 리소스 메타데이터와 작동합니다.
- helper script는 스택 생성과정에서 Amazon EC2인스턴스에서 실행됩니다.
- 스크립트는 기본적으로 실행되지 않습니다. 특정 helper script를 실행하는 호출 템플릿에 포함되어 있어야 합니다.

## cfn-hup 작동 방식
- CloudFormation 스택에서 리소스 메타데이터의 변경 사항 폴링
- 변경 사항이 감지되면 사용자 지정 작업 실행
- 리소스 메타데이터 변경 사항 감지 가능
```bash
cfn-hup --config| -c config.dir --no-daemon --verbose| -v
```
- CloudFormation은 리소스 메타데이터를 사용하지 않으므로 리소스에 연결된 외부 프로세스에서 사용하는 메타데이터 객체를 생성할 수 있습니다.
- 예를 들어 정적 코드 분석 도구를 사용하여 리소스를 검사하고 메타 데이터에 배치하여 해당 도구에 정보를 전달 할 수 있습니다.
- cfn helper script는 같은 방식으로 메타데이터를 사용합니다.
- 메타데이터를 템플릿의 나머지 부분과 동일한 형식 지정 규칙을 따라야 하는 주석이라고 생각하면 됩니다.

- CloudFormation은 메타데이터를 사용하지 않으므로 스택을 업데이트할 대 해당 메타데이터에 대한 변경 사항이 감지 되지 않습니다.
- 리소스 메타데이터만 변경하는 경우 해당 변경 사항을 감지하는 다른 프로세스가 있어야 합니다.
- cfn-hup은 이 작업을 수행하는 CloudFormation helper script 입니다.
	- Ex1)
		- 템플릿에서 로컬 웹 페이지를 변경하고 기존 스택을 업데이트하여 배포 할 수 있다
	- Ex2)
		- `cfn-init` 을 사용하여 데이터 베이스 엔드포인트 정보로 파일을 만들 수 있습니다.
		- 해당 정보가 변경되면 cfn-init에서 사용된 메타데이터를 업데이트 할 수 있으며, cfn-hup은 메타데이터 변경을 감지하고 이를 대체하기 위해 지정한 스크립트를 실행합니다.
- `--config | -c config.dir:cfn-hup` 스크립트가 `cfn-hup.conf` 및 `hooks.d` 디렉토리를 찾는 경로를 지정합니다. 
- Windows에서 기본 경로는 `system_drive/cfn`입니다.
- 리눅스에서는 `/etc/cfn` 입니다.
- `--no-daemon`
	- 이 옵션을 지정하면 `cfn-hup` 스크립트를 한번 실행한 다음 종료합니다.
- `cfn-hup.conf` 파일은 `cfn-hup` 데몬이 대상으로 지정한 스택의 이름과 AWS 자격 증명을 저장합니다.
- `cfn-hup`에 대한 자세한 내용은 아래의 URL로 참고하면 됩니다.
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-hup.html

## 예시 : cfn-hup.conf configuration
### cfn-hub.conf
```conf
[main]
stack=MyStackName
region=us-west-2
Interval=5
```

### hooks.conf
```conf
[cfn-auto-reloader-hook]
triggers=post.update
patt=Resources.WebServer.Metadata::CloudFormation::Init
Action=/opt/aws/bin/cfn-init -v --stack MyStackName --resource WebServer \
	--region us-west-2 --configsets updateResource
```
- cfn-hup.conf 파일에는 스택의 이름 , 스택이 있는 리전 및 리소스 메타 데이터의 변경 사항 확인에 사용되는 간격이 저장됩니다.
- 이 예에서는 5분마다 실행되므로 CloudFormation 스택을 업데이트 하면 5분 이내에 변경 사항이 감지 됩니다.
- 지정되지 않는 경우 기본 간격은 15분입니다.

- hooks.conf 파일에는 메타 데이터 변겨잉 감지된 경우 수행해야하는 사용자 작업이 이슷빈다. 



## AWS CloudFormation StackSets
![Pasted-image-20230327100038.png](/img/Pasted-image-20230327100038.png)
- AWS CloudFormation 스택 세트는 한번의 작업으로 여러 계정과 리전에 걸처 스택을 생성, 업데이트 또는 삭제할 수 있도록 하여 스택 기능을 확장합니다.
- 관리자 계정을 사용하여 AWS CloudFormation 템플릿을 정의 및 관리하고, 템플릿을 지정된 리전에 대해 선택한 대상 계정으로 스택을 프로비저닝하기 위한 기본으로 사용합니다.
- 스택 작업은 다른 AWS 계정에서 생성해야하는 IAM 역할을 사용합니다.

- **관리자 계정**
	- 스택 세트를 생성할 때 사용되는 AWS 계정입니다.
	- 스택 세트는 처음 생성했던 AWS 관리자 계정에 로그인하여 관리합니다.
- **대상 계정**
	- 스택 세트에서 하나 이상의 스택을 생성, 업데이트 또는 삭제할 계정입니다.
	- 스택 세트를 사용하여 대상 계정에 스택을 생성하기 전ㅇ에 관리자 계정과 대상 계정 간의 신뢰 관계를 설정해야합니ㅏㄷ.
- **스택 세트**
	- 스택 세트를 사용하면 단일 AWS CloudFormation 템플릿을 사용하여 여러 리전의 AWS 계정에 스택을 생성할 수 있습니다.
	- 스택 세트를 생성할 때는 사용할 템플릿과 템플릿에 필요한 파라미터 및 기능을 지정합니다.
- 스택 세트는 리전별 리소스 입니다. 할 리전에서 만든 스택 세트는 다른 리전에서 보거나 변경할 수 없다.
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/what-is-cfnstacksets.html

```json
"Statement" : [
	{
		"Effect" : "Deny",
		"Principal" : "*",
		"Action" : "Update:*",
		"Resource" : "*",
		"Condition": {
			"StringEquals" : {
				"ResourceType": [ "AWS::EC2::Instance", "AWS::RDS::DBInstance" ] 
			}
		}
	},
	{
		"Effect" : "Allow",
		"Principal" : "*",
		"Action" : "Update",
		"Resource" : "*"
	}
	
]
```
- 스택 정책은 지정된 리소스에 대해 수행할 수 있는 업데이트 작업을 정의하는 JSON 문서입니다.
- 이 정책을 사용하여 스택 업데이트 중에 스택 리소스를 실수로 업데이트 하거나 삭제하는 것을 방지 합니다.
- 사용자는 스택 정책에 대해 적절한 IAM 권한이 있는 작업에만 수행할 수 있습니다.

- 스택 정책은 스택 업데이트 중에만 적용되며, 특정 스택 리소스가 실수로 업데이트 되는 것을 방지하는 안전 메커니즘으로만 사용해야한다.
- 스택 정책은 AWS 리소스에 대한 액세스 또는 작업을 제어하는 데 사용하면 안됩니다.
- 이때는 IAM을 사용해야합니다.
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html

## 예시 : DeletionPolicy
```yaml
MyDB:
	Type: "AWS::RDS::DBInstance"
	DeletionPolicy: "Snapshot"
	Properties:
		DBName:
			Ref: "DBName"
		DBInstanceClass:
			Ref: "DBInstanceClass"
		Engine: "MySQL"
		EnginVersion: "5.5"
```
- 스택이 삭제될 때 리소스를 보존하거나 백업하는 데 사용합니다.

### DeletionPolicy 옵션
- Delete
- Retain
- 스냅샷

### 옵션
- **Delete**
	- DeletionPolicy 속성이 없는 경우 AWS CloudFormation에서 리소스를 삭제합니다.
- **Retain**
	- AWS CloudFormation에서 스택 삭제가 완료되면 스택은 Delete_Complete 상태가 됩니다.
	- 하지만 보관된 리소스는 계속 존재하며 해당 리소스를 삭제할 때까지 적용 요금이 계속 발생합니다.
- **Snapshot - 스냅샷을 지원하는 리소스:**
	- `AWS::EC2::Volume`
	- `AWS::ElastiCache::CacheCluster`
	- `AWS::ElastiCache::ReplicationGroup`
	- `AWS::RDS::DBInstace`
	- `AWS::RDS::DBCluster`
	- `AWS::Redshift::Cluster`
- AWS CloudFormation에서는 리소스를 삭제하기 전에 해당 리소스에 대한 스냅샷을 생성합니다.
- https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-deletionpolicy.html


## 스택에서 드리프트 감지
- 예상 구성과 비교한 스택의 실제 구성 상태:
	- DRIFTED
	- NOT_CHECKED
	- IN_SYNC
- AWS CloudFormation을 통해 리소스를 관리하더라도 사용자 AWS CloudFormation 외부에서 이러한 리소스를 변경할 수 있습니다.
- 사용자는 해당 리소스를 생성한 기본 서비스를 사용하여 직접 리소스를 편집할 수 있다.
- 드리프트란 드리프트 감지 기능을 사용하면 스택의 실제 구성이 예상 구성과 다르거나 드리프트 했는지 여부를 감지 할 수 있다.

- **AWS CloudFormation은 드리프트를 어떻게 감지합니까?**
	- 리소스의 드리프트를 확인하기 위해 AWS CloudFormation은 스택 템플릿에 정의된 것과 같은 예상되는 리소스 속성 값과 템플릿 파라미터로 지정된 값을 결정합니다.
	- 그런 다음 `AWS CloudFormation`에서 해당 예상 값을 스택에 현재 존재하는 리소스 속성의 실제 값과 비교한다.
	- 리소스는 하나 이상의 속성이 삭제되었거나 값이 변경된 경우 드리프트 된 것으로 간주합니다.
	- 스택의 드리프트를 감지할 때 `AWS CloudFormation`에서 해당 스택에 속하는 중첩 스택의 드리프트를 감지하지 않습니다.
	- 대신 중첩 스택에서 직접 드리프트 감지 작업을 개시할 수 있습니다.
- **드리프트 상태**
	- **DRIFTED**
		- 스택이 예상 템플릿 구성과 다릅니다.
		- 스택은 하나 이상의 리소스가 드리프트된 경우 드리프트 된 것으로 간주됩니다.
	- **NOT_CHECKED** 
		- AWS CloudFormation에서 스택이 예상 템플릿 구성과 다른지 여부를 확인하지 않았습니다.
	- **IN_SYNC**
		- 스택의 실제 구성이 예상 템플릿 구성과 일치 합니다.

## 방해가 되는 작업 방지
|계층|보호기능|
|--|--|
|스택|종료방지|
|리소스 그룹|스택 정책|
|리소스|DeletionPolicy 속성|
|IAM 사용자/역할| IAM 정책|
![Pasted-image-20230327112856.png](/img/Pasted-image-20230327112856.png)
- 기본적으로 업데이트 권한이 있는 사용자는 누구나 스택의 모든 리소스를 업데이트 할 수 있습니다.
- 하지만 업데이트 중에 일부러 리소스가 중단되어야 하거나 완전히 교체되어야 할 수 있으며, 이로 인해 새로운 물리적 ID 또는 완전히 새로운 스토리지가 생길 수 있습니다.
- 누구도 이러한 리소스를 실수로 업데이트 하기 못하게 하려면 스택 정책을 설정하면 됩니다.
- 스택 정책은 사용자가 보호된 리소스를 실수로 업데이트 하는 것을 방지합니다.
- 보호된 리소스를 업데이트하려는 경우 해당 리소스를 명시적으로 지정해야합니다.

AWS CloudFormation 스택의 리소스 삭제 도는 업데이트를 방지하려면 다음을 수행할 수 있습니다.
- 스택 수준에서 개별 리소스가 삭제되지 않도록 DeletionPolicy속성을 설정합니다.
- AWS Identity and Access Management(IAM) 정책을 사용하여 사용자가 스택 및 해당 리소스를 삭제 또는 업데이트 하는 것을 제한합니다.
- 스택 리소스를 업데이트하지 못하도록 스택 정책을 할당합니다.
- 사용자가 AWS CloudFormation 콘솔 또는 AWS CLI에서 스택을 삭제하지 못하도록 종료 방지를 활성화합니다.

 >[!tip] 중요
 >- 스택 설정을 설정한 후에는 해당 리소스에 대한 정책을 명시적으로 설정하지 않았더라도 스택의 모든 리소스는 기본적으로 보호 됩니다.
 >- 업데이트를 허용하려는 리소스가 있는 경우 해당 리소스에 대해 명시적 Allow 문을 지정해야합니다.
 
- 가장 단순한(그리고 가장 허용적인) 권한 구성은 관리자 계정의 모든 사용자 및 그룹에게 해당 계정을 통해 관리하는 모든 스택 세트를 생성하고 업데이트 하는 기능을 제공하는 것입니다.
- 이렇게 하려면 관리자 및 모든 대상 계정에 대한 IAM 서비스 역할을 생성합니다.
- 관리자 계정에 대한 권한을 가진 누구나 모든 대상 계정의 스택 세트를 생성, 업데이트 또는 삭제할 권한을 갖습니다.

- 관리자 계정 및 대상 계정에는 계정 간의 신뢰 관계를 생성하고, 대산 계정에 템플릿에 설명된 리소스를 생성 및 관리 할 수 있는 권한을 부여하는 서비스 역할이 구성되어 있어야 합니다.
- 이런 방식으로 권한 구조가 이루어진 경우에는 사용자가 스택 세트를 생성 또는 업데이트할 때 관리자 역할을 전달하지 않습니다.


## 사용자 지정 리소스
- 다음과 같은 리소스를 포함 :
	- 표준 AWS CloudFormation 리소스로 지원되지 않는 리소스
	- AWS 외부 리소스
- 단일 스택에서 모든 관련 리소스 관리
- `AWS::CloudFormation:CustomResource`를 사용하여 지정
- 타사 리소스 공급자를 사용하거나 자체 사용자 지정 리소스 생성

- 사용자 지정 리소스를 사용하면 스택을 생성, 업데이트(사용자 지정 리소스를 변경한 경우) 또는 삭제할 때마다 AWS CloudFormation에서 실행하는 템플릿에서 사용자 지정 프로비저닝 로직을 작성할 수 있습니다.
- 사용자 지정 리소스를 사용하면 AWS CloudFormation 스택에 비 AWS 리소스를 포함할 수 있습니다.
- 따라서 표준 AWS CloudFormation 리소스 유형으로 지원되지 않는 스택 리소스를 추가할 수 있습니다.
- 사용자 지정 리소스를 사용하면 스택과 동일한 수명 주기를 공유하는 모든 리소스를 추가하고 이를 단일 스택에서 관리할 수 있습니다.


## 예시) 사용자 지정 리소스 워크플로
![Pasted-image-20230413091211.png](/img/Pasted-image-20230413091211.png)
- 사용자는 AWS CloudFormation 템플릿을 생성할 때 사용자 지정 리소스 작업이 포함된 스택을 사용합니다.
- 사용자 지정 리소스 작업은 `AWS::CloudFormation::CustomResource` 또는 `Custom:CustomResource` 를 사용하여 정의됩니다.
- 템플릿에는 타사 리소스 공급자가 인증을 위해 제공한 서비스 토큰과 사용자 지정 리소스에 필요한 공급자 정의 파라미터가 포함됩니다.

- AWS CloudFormation은 생성, 업데이트 또는 삭제 요청이 포함된 Amazon Simple Notification Service(Amazon SNS)메세지를 사용하여 사용자 지정 리소스 공급자와 통신합니다.
- 이 메시지에는 스택 템플릿에 저장된 입력 데이터와 응답에 사용할 Amazon S3 URL도 포함됩니다.

- 사용자 지정 리소스 공급자는 이 메시지를 처리하고 성공 또는 실패 응답을 AWS CloudFormation에 반환합니다. 사용자 지정 리소스 공급자는 요청이 성공한 경우 리소스 속성의 이름과 값을 반환하고,
- 요청이 실패한 경우 세부 정보가 담긴 문자열을 전송합니다.

- AWS CloudFormation은 수신된 응답에 따라 스택 상태를 설정하고 사용자 지정 리소스 출력 데이터의 값을 제공합니다.
- AWS Lambda 함수를 사용자 지정 리소스 역할로 사용할 수 있습니다.
- 이를 구현하려면 사용자 리소스의 ServiceTocken을 AWS Lambda 사용자 지정 리소스의 Amazon 리소스 이름(ARN)으로 대체하면 됩니다.
- 다시 말해 AWS Lambda를 사용하면, 사용자 지정 리소스에 대한 Amazon SNS 주제를 생성할 필요가 없습니다.
- AWS CloudFormation은 AWS Lambda를 인식합니다.

## AWS CloudFormation 템플릿 테스트

### AWS TaskCat
![Pasted-image-20230413094518.png](/img/Pasted-image-20230413094518.png)
- AWS CloudFormation 템플릿 테스트를 하는 오픈소스 도구입니다.
	- 동시에 여러 AWS 리전에 스택을 생성하고 리전별로 통과/실패 등급으로 보고서를 생성합니다.
	- 사용자는 리저을 지정하고, 테스트에 포함할 가용 영역 수를 표시하고, 테스트할 AWS CloudFormation 파라미터 값을 전달할 수 있습니다.
	- CI/CD 파이프라인을 사용하여 중첩 템플릿을 비롯해 GitHub 리포지토리의 모든 AWS CloudFormation 템플릿을 테스트 할 수 있습니다.









































