---
slug: "11.-Prisma"
---
:::tip 자세한 내용은 [Nest 공식문서](https://docs.nestjs.com/recipes/prisma)를 참조하면 됩니다.

:::

# 설치 방법
```shell
npm install prisma @prisma/client

# prisma 초기화
npx prisma init

# schema.prisma 파일을 바탕으로 해당 model을 만들어 냅니다.
npx prisma migrate dev --name init

# schema.prisma 파일을 바탕으로 해당 migrate를 초기화 하고 싶다면
npx prisma migrate reset

# Prisma 변경사항 반영 하고 싶다면
prisma migrate dev
# 또는
npx prisma db push
```

# 트랜젝션

Prisma를 사용하다 보니, 기본적으로 DB에, 단건의 데이터를 수정하는 일은 그다지 많이 있진 않다.
나도 개발을 해보니, 다건 업데이트 다건 삭제가 많이 존재하지, 단건은 그다지..

그러니 다건에 조회는 있어도, ORM 특성상 다건 Update는 많이 존재하진 않았는데 , Prisma 역시도 자체적으로는 존재하진 않고, `Promise.all()` 함수로 대체하는 것 같다.

뭐 아예 없는 건 아니고, 
```js
await this.prisma.pxCoreOrganization.updateMany({
  where: {
    id: { in: [1, 2, 3] }, // 같은 조건으로 묶일 때만!
  },
  data: {
    isDeleted: true, // 모든 대상에게 동일한 값만 가능
  },
});
```
`updateMany` 라는 값을 사용하면 되긴 하는데, 사실상 제한적이다.

이유인 즉슨 모든 대상에게 동일한 값만 가능하다..라면 사실상 Soft Delete 정도만 호환될 듯 하다.
즉, 거의 쓸일 없다 ㅋㅋ

그래서 대안으로 내놓은 것이 `Promise.all()`기법 인데, 이 마져도 트랜젝션을 당연하겠지만, 지원하진 않는다.
```js
const updates = updateList.map((item) =>
  this.prisma.pxCoreOrganization.update({
    where: { id: item.id },
    data: item.data,
  }),
);

await Promise.all(updates);

```

솔직히 당연하긴 함 js 기본 문법인 `Promise.all` 이 어떻게 트랜젝션을 지원하는가..
그래서 뭐 prisma도 여기서 끝난다면 사실 안하니만 못하니 지원하는 코드 자체는 있다.

아래처럼 사용하면 된다.

```js
await this.prisma.$transaction([
  this.prisma.pxCoreOrganization.update({
    where: { id: 1 },
    data: { name: 'Org A' },
  }),
  this.prisma.pxCoreUser.update({
    where: { id: 5 },
    data: { role: 'ADMIN' },
  }),
  this.prisma.pxCoreRole.update({
    where: { id: 10 },
    data: { isActive: false },
  }),
]);
```

위와 같은 식으로, 해당 update를 할 때 하나씩 묶어서 하면 된다.

혹은 여러개의 데이터를 하나의 데이터에 업뎃을 하고 싶다면 아래와 같이 사용하면 된다.
```js
const operations = updateList.map((item) =>
  this.prisma.pxCoreOrganization.update({
    where: { id: item.id },
    data: item.data,
  }),
);

await this.prisma.$transaction(operations);
```

결국은 반복문을 통한 업데이트를 하라는 수식이긴 하다.


# Prisma 문법

## 다대다 관계

|동작|설명|
|---|---|
|`connect`|관계 추가|
|`disconnect`|관계 해제|
|`set`|기존 관계를 모두 제거 후 새 관계로 설정 (connect + disconnect 동시)|
### `connect`

```ts
await prisma.user.update({
  where: { id: userId },
  data: {
    roles: {
      disconnect: { id: roleId },
    },
  },
});
```

### `disconnect`
```ts
await prisma.user.update({
  where: { id: userId },
  data: {
    roles: {
      disconnect: { id: roleId },
    },
  },
});
```

### `set`

```ts
await prisma.user.update({
  where: { id: userId },
  data: {
    roles: {
      set: [
        { id: 1 },
        { id: 3 },
      ],
    },
  },
});
```


---

#NodeJS #NestJS #ORM #Back 

---